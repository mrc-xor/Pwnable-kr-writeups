#include <netinet/in.h>
#include <stdio.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>


int main(){
    char *args[101];

    for(int i = 0;i <100; i++){
        args[i] = "A";
    }
    
    args['A'] = "\x00";
    args['B'] = "\x20\x0a\x0d";
    args['C'] = "2456";
    args[100] = NULL;
    //args[101] = "\x00";
    
    int pipe_stdin[2];
    int pipe_stderr[2];
    pid_t cpid;

    if(pipe(pipe_stdin) < 0 || pipe(pipe_stderr) < 0){
        perror("pipe error");
        exit(-1);
    }

    if((cpid = fork()) < 0){
        perror("fork error");
        exit(-1);
    }
    
    setenv("\xde\xad\xbe\xef", "\xca\xfe\xba\xbe", 1);
    extern char** environ;


    FILE *fp = fopen("\x0a","w");
    fwrite("\x00\x00\x00\x00", 4,1 , fp);
    fclose(fp);
    int sd,cd;
    struct sockaddr_in saddr,caddr;

    if(cpid == 0){

        close(pipe_stdin[0]);
        close(pipe_stderr[0]);

        write(pipe_stdin[1],"\x00\x0a\x00\xff",4);
        write(pipe_stderr[1],"\x00\x0a\x02\xff",4);
        sleep(5);

        sd = socket(AF_INET,SOCK_STREAM,0);
        saddr.sin_family = AF_INET;
        saddr.sin_port = htons(atoi(args['C']));
        saddr.sin_addr.s_addr = INADDR_ANY;

        connect(sd,(const struct sockaddr*)&saddr,sizeof(saddr));
        write(sd, "\xde\xad\xbe\xef",4);
        return 0;
    }else{
        close(pipe_stdin[1]);
        close(pipe_stderr[1]);

        dup2(pipe_stdin[0],0);
        dup2(pipe_stderr[0],2);

        close(pipe_stdin[0]);
        close(pipe_stderr[0]);



        execve("/home/cyber0/playground/pwnable-kr/input2/input2",args,environ);
    }
   // execve("./input2",args,NULL);
}
